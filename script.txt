import { sendToBackend } from './js/SendToBackend.js';


/*
  Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©:
  - ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ØªØ­Ù‚Ù‚ (ÙˆØ§Ø­Ø¯ Ø­Ù‚ÙŠÙ‚ÙŠ Ùˆ4 ÙˆÙ‡Ù…ÙŠÙŠÙ†).
  - ÙŠØªÙ… Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø´ÙŠØ¡ ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… CSS.
  - ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ù…Ø§ÙŠØ© Ø²Ù…Ù†ÙŠØ© (Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø§Ù„Ù†Ù‚Ø± ÙÙˆØ±Ù‹Ø§).
*/

let realCheckboxReference = null; // ÙÙ‚Ø· Ù†Ø®Ø²Ù† Ù…Ø±Ø¬Ø¹Ù‡ Ø¨Ø§Ù„Ø°Ø§ÙƒØ±Ø©
let allowClick = false;  //Ù…ÙŠØ²Ø© Ø§Ù„ØªØ£Ø®ÙŠØ± Ø§Ù„Ø²Ù…Ù†ÙŠ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¨ÙŠÙ† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª ÙˆØ§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†Ù‚Ø±


// ğŸ”§ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­Ø³ÙŠÙ† Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù‚Ù‚
// âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ù‚Ø± Ø³Ø±ÙŠØ¹Ù‹Ø§ Ø¬Ø¯Ù‹Ø§ (Ø£Ù‚Ù„ Ù…Ù† 300ms)
function isClickTooFast(timeDiff) {
    return timeDiff !== null && timeDiff < 300;
}
// âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù†Ù‚Ø±Ø© ÙÙŠ Ø§Ù„Ù…Ù†ØªØµÙ ØªÙ…Ø§Ù…Ù‹Ø§ (Ø¶Ù…Ù† Ù‡Ø§Ù…Ø´ Ø§Ù„Ø®Ø·Ø£)
function isCenterClick(diffX, diffY, tolerance = 1) {
    return diffX < tolerance && diffY < tolerance;
}




// âœ… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„: Ø§Ø¨Ø¯Ø£ ØªÙ†ÙÙŠØ° Ø¥Ø¹Ø¯Ø§Ø¯ CAPTCHA (Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø§Ø«)
document.addEventListener("DOMContentLoaded", () => {
    const checkboxContainer = document.getElementById("checkbox-container");
    const captchaBox = document.querySelector(".captcha-box");


    let userInteraction = {
        lastTime: 0,
        lastX: 0,
        lastY: 0,
        mouseMoved: false
    };

    function showMessage(text, type = "info") {
        const msgEl = document.getElementById("captcha-message");
        msgEl.textContent = text;
        msgEl.className = "captcha-message";
        msgEl.classList.add(type);
    }

    // ğŸŸ¢ ØªØªØ¨Ø¹ Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø§ÙˆØ³
    document.addEventListener("mousemove", (event) => {
        if (Math.abs(event.movementX) > 1 || Math.abs(event.movementY) > 1) {
            userInteraction.mouseMoved = true;
        }
    });

    // ğŸŸ¢ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¨Ø¹Ø§Øª
    function createCheckBoxes() {
        let checkboxes = [];
        for (let i = 0; i < 4; i++) {
            let checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.classList.add("hidden-checkbox");
            checkboxes.push(checkbox);
        }

        let realCheckbox = document.createElement("input");
        realCheckbox.type = "checkbox";
        realCheckbox.classList.add("hidden-checkbox");
        realCheckboxReference = realCheckbox;

        realCheckbox.style.outline = "2px solid limegreen"; // ÙÙ‚Ø· Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±

        let possiblePositions = [1, 3];
        let randomIndex = possiblePositions[Math.floor(Math.random() * possiblePositions.length)];
        checkboxes.splice(randomIndex, 0, realCheckbox);

        return checkboxes;
    }

    function shuffleCheckBoxes() {
        checkboxContainer.innerHTML = "";
        let newCheckBoxes = createCheckBoxes();
        newCheckBoxes.forEach(c => checkboxContainer.appendChild(c));
        allowClick = false;

        const delay = 500 + Math.random() * 1000;
        setTimeout(() => {
            allowClick = true;
            console.log(`ğŸŸ¢ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¨Ø¹Ø¯ ${Math.round(delay)}ms`);
        }, delay);
    }

    shuffleCheckBoxes();

    checkboxContainer.addEventListener("click", (event) => {
        let now = Date.now();
        let clickX = event.clientX;
        let clickY = event.clientY;
        let timeDiff = userInteraction.lastTime ? now - userInteraction.lastTime : null;

        userInteraction.lastTime = now;

        let distance = Math.sqrt(Math.pow(clickX - userInteraction.lastX, 2) + Math.pow(clickY - userInteraction.lastY, 2));

        if (!allowClick || isClickTooFast(timeDiff) || !userInteraction.mouseMoved || distance < 10) {
            console.warn("âŒ Ù†Ù‚Ø± Ù…Ø´Ø¨ÙˆÙ‡");
            event.preventDefault();
            return;
        }

        if (event.target === realCheckboxReference) {
            let rect = event.target.getBoundingClientRect();
            let diffX = Math.abs(clickX - (rect.left + rect.width / 2));
            let diffY = Math.abs(clickY - (rect.top + rect.height / 2));

            if (isCenterClick(diffX, diffY)) {
                console.warn("ğŸ¤– Ù†Ù‚Ø±Ø© Ù…Ø«Ø§Ù„ÙŠØ©! Ù…Ø­ØªÙ…Ù„ Ø±ÙˆØ¨ÙˆØª");
                event.preventDefault();
                return;
            }

            console.log("âœ… Ø§Ø¬ØªØ§Ø² Ø§Ù„ØªØ­Ù‚Ù‚");
            showMessage("âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­!", "success");
            MouseTracker.handleClick(event);
        } else {
            console.warn("âš ï¸ Ø§Ø®ØªÙŠØ§Ø± Ø®Ø§Ø·Ø¦. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©");
            showMessage("âš ï¸ Ù‡Ø°Ø§ Ù„ÙŠØ³ Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„ØµØ­ÙŠØ­ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "warning");
            shuffleCheckBoxes();
        }

        userInteraction.lastX = clickX;
        userInteraction.lastY = clickY;
        userInteraction.mouseMoved = false;
    });

    // âœ… Ø±Ø¨Ø· ØªØªØ¨Ø¹ Ø§Ù„Ø­Ø±ÙƒØ© Ø¯Ø§Ø®Ù„ captcha-box
    if (captchaBox) {
        captchaBox.addEventListener("mouseenter", (event) => MouseTracker.startTracking(event));
        captchaBox.addEventListener("mousemove", (event) => MouseTracker.trackMovement(event));
    }
});




// 1ï¸âƒ£ ÙŠØªØªØ¨Ø¹ Ø³Ø±Ø¹Ø© Ø§Ù„Ù…Ø§ÙˆØ³ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø¯Ø®ÙˆÙ„Ù‡ captcha-box.
// 2ï¸âƒ£ ÙŠØ®Ø²Ù† ÙÙ‚Ø· Ø¢Ø®Ø± 5 Ø³Ø±Ø¹Ø§Øª Ù„Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ¨Ø§Ø·Ø¤ (decelerationRate).
// 3ï¸âƒ£ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ real-checkboxØŒ ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ JSON ÙŠØªØ¶Ù…Ù†:

const MouseTracker = {
    entryTime: null,
    speedLog: [],
    maxSpeed: 0,
    suddenStopCount: 0,
    trackingActive: false,

    startTracking(event) {
        this.entryTime = Date.now();
        this.speedLog = [];
        this.maxSpeed = 0;
        this.suddenStopCount = 0;
        this.trackingActive = true;
    },

    trackMovement(event) {
        if (!this.trackingActive) return;

        let dx = event.movementX;
        let dy = event.movementY;
        let speed = Math.sqrt(dx * dx + dy * dy);

        if (speed > 0.5) {
            this.speedLog.push(speed);
            if (speed > this.maxSpeed) this.maxSpeed = speed;

            // âœ… Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆÙ‚ÙØ§Øª Ø§Ù„Ù…ÙØ§Ø¬Ø¦Ø©
            if (this.speedLog.length > 1 && this.speedLog[this.speedLog.length - 2] > 2 && speed < 0.5) {
                this.suddenStopCount++;
            }

            // âœ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ ÙÙ‚Ø· Ø¨Ø¢Ø®Ø± 10 Ø³Ø±Ø¹Ø§Øª
            if (this.speedLog.length > 10) {
                this.speedLog.shift();
            }
        }
    },

    handleClick(event) {
        if (!this.trackingActive) return;

        let clickTime = Date.now();
        let movementTime = clickTime - this.entryTime;
        let lastSpeed = this.speedLog.length > 0 ? this.speedLog[this.speedLog.length - 1] : 0;

        // âœ… ØªØ­Ø³ÙŠÙ† `decelerationRate` Ù„ÙŠÙƒÙˆÙ† Ø£ÙƒØ«Ø± Ø¯Ù‚Ø©
        let lastSpeeds = this.speedLog.slice(-5);
        let avgLastSpeed = lastSpeeds.length > 0 ? lastSpeeds.reduce((a, b) => a + b, 0) / lastSpeeds.length : 0;
        let decelerationRate = avgLastSpeed > 0 ? (avgLastSpeed - lastSpeed) / avgLastSpeed : 0;
        decelerationRate = decelerationRate < 0 ? 0 : parseFloat(decelerationRate.toFixed(2)); // Ù…Ù†Ø¹ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø³Ù„Ø¨ÙŠØ© ØºÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚ÙŠØ©

        // âœ… ØªØ­Ø³ÙŠÙ† `speedStability` Ù„ÙŠØ£Ø®Ø° ÙÙŠ Ø§Ù„Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù„ØªØºÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ù„Ù„Ø¨Ø´Ø±
        let meanSpeed = this.speedLog.length > 0 ? this.speedLog.reduce((a, b) => a + b, 0) / this.speedLog.length : 0;
        let speedVariance = this.speedLog.length > 1 ? this.speedLog.reduce((sum, speed) => sum + Math.pow(speed - meanSpeed, 2), 0) / this.speedLog.length : 0;
        let speedStability = Math.sqrt(speedVariance);
        speedStability = parseFloat(speedStability.toFixed(2));

        // âœ… Ø¥Ø¶Ø§ÙØ© `movementPattern` Ù„ØªØ­Ù„ÙŠÙ„ Ù†Ù…Ø· Ø§Ù„Ø­Ø±ÙƒØ©
        let movementPattern = "normal";
        if (speedStability < 0.1) {
            movementPattern = "too stable"; // Ø§Ù„Ø±ÙˆØ¨ÙˆØªØ§Øª ØªØªØ­Ø±Ùƒ Ø¨Ø«Ø¨Ø§Øª ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠ
        } else if (speedStability > 2.0) {
            movementPattern = "chaotic"; // Ø§Ù„Ø¨Ø´Ø± Ø¹Ø§Ø¯Ø© Ù„Ø§ ÙŠØªØ­Ø±ÙƒÙˆÙ† Ø¨ÙÙˆØ¶ÙˆÙŠØ© Ø´Ø¯ÙŠØ¯Ø©
        }

        // âœ… ØªØ­Ø³ÙŠÙ† `behaviorType`
        let behaviorType = "human";
        let uncertainConditions = 0;

        if (movementTime < 200) uncertainConditions++; // ÙˆÙ‚Øª Ø§Ù„Ø­Ø±ÙƒØ© Ù‚ØµÙŠØ± Ø¬Ø¯Ù‹Ø§
        if (speedStability < 0.1) uncertainConditions++; // Ø§Ù„Ø³Ø±Ø¹Ø© Ø«Ø§Ø¨ØªØ© Ø¬Ø¯Ù‹Ø§
        if (decelerationRate < 0.2) uncertainConditions++; // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¨Ø§Ø·Ø¤ ÙƒØ§ÙÙ
        if (this.suddenStopCount > 3) uncertainConditions++; // Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆÙ‚ÙØ§Øª Ø§Ù„Ù…ÙØ§Ø¬Ø¦Ø© ÙƒØ¨ÙŠØ±

        if (uncertainConditions >= 2) {
            behaviorType = "uncertain"; // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† Ø¹Ø§Ù…Ù„ ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠ
        }

        // ğŸŸ¢ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ JSON
        let jsonData = {
            maxSpeed: parseFloat(this.maxSpeed.toFixed(2)),
            lastSpeed: parseFloat(lastSpeed.toFixed(2)),
            decelerationRate: decelerationRate,
            decelerationRatio: Math.round((this.maxSpeed - lastSpeed) / this.maxSpeed * 100),
            speedStability: speedStability,
            movementTime: movementTime,
            suddenStopCount: this.suddenStopCount,
            speedTrend: decelerationRate > 0.6 ? "gradual" : "sharp",
            movementPattern: movementPattern,
            behaviorType: behaviorType
        };

        // ğŸ“Œ Ø¹Ø±Ø¶ JSON ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        console.log("ğŸ“Œ JSON Data:", JSON.stringify(jsonData, null, 2));


        // ğŸŸ¢ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ API  to BackEnd from SendToBackend.js
        sendToBackend(jsonData);


        // ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ù‚Ø±
        this.trackingActive = false;
    }



};


