// ğŸ“ main.js
// âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª
import { MouseTracker } from './MouseTracker.js';
import { createCheckBoxes } from './checkboxGenerator.js';
import { isClickTooFast, isCenterClick } from './validator.js';
import { sendToBackend } from './SendToBackend.js';

// âœ… Ø¹Ù†Ø§ØµØ± HTML
const checkboxContainer = document.getElementById("checkbox-container");
const captchaBox = document.querySelector(".captcha-box");

// âœ… Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§
const CaptchaState = {
    realCheckbox: null,
    allowClick: false,
    fakeClickCount: 0,
    fakeBoxIndexes: [],
    userInteraction: {
        lastTime: 0, lastX: 0, lastY: 0,
        mouseMoved: false
    }
};

// âœ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§
function setupCaptcha() {
    const checkboxes = createCheckBoxes();
    CaptchaState.realCheckbox = checkboxes.real;

    checkboxContainer.innerHTML = "";
    checkboxes.all.forEach(box => checkboxContainer.appendChild(box));

    CaptchaState.allowClick = false;
    const delay = 500 + Math.random() * 1000;
    setTimeout(() => {
        CaptchaState.allowClick = true;
        console.log(`ğŸŸ¢ Click allowed after ${Math.round(delay)}ms`);
    }, delay);
}

// âœ… Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener("DOMContentLoaded", () => {
    document.addEventListener("mousemove", (event) => {
        if (Math.abs(event.movementX) > 1 || Math.abs(event.movementY) > 1) {
            CaptchaState.userInteraction.mouseMoved = true;
        }
    });

    setupCaptcha();

    checkboxContainer.addEventListener("click", async (event) => {

      

        let now = Date.now();
        let clickX = event.clientX;
        let clickY = event.clientY;
        let timeDiff = CaptchaState.userInteraction.lastTime ? now - CaptchaState.userInteraction.lastTime : null;
        CaptchaState.userInteraction.lastTime = now;

        let dx = clickX - CaptchaState.userInteraction.lastX;
        let dy = clickY - CaptchaState.userInteraction.lastY;
        let distance = Math.hypot(dx, dy);

        if (!CaptchaState.allowClick ||
            isClickTooFast(timeDiff) ||
            !CaptchaState.userInteraction.mouseMoved ||
            distance < 10) {
            console.warn("âš ï¸ Suspicious click attempt");
            return handleFakeClick(event);
        }

        if (event.target === CaptchaState.realCheckbox) {
            let rect = event.target.getBoundingClientRect();
            let diffX = Math.abs(clickX - (rect.left + rect.width / 2));
            let diffY = Math.abs(clickY - (rect.top + rect.height / 2));

            if (isCenterClick(diffX, diffY)) {
                console.warn("ğŸ¤– Click was too perfect, suspicious");
                return handleFakeClick(event);
            }

            console.log("âœ… Verification successful");
            CaptchaState.fakeClickCount = 0;
            CaptchaState.fakeBoxIndexes = [];

            const data = MouseTracker.handleClick(event);
            if (!data || !data.speedSeries || data.speedSeries.length < 5) {
                console.warn("â›” Ignored incomplete or invalid data.");
                return;
            }

           const result = await sendToBackend(data);


                  if (result?.status === "human") {
                    document.getElementById("captcha-static-label").style.display = "none";

                    checkboxContainer.innerHTML = `
                        <div style="color: green; font-size: 20px; font-weight: bold;">
                        âœ… Welcome! You have been verified as human.
                        </div>`;
                    }






        } else {
            handleFakeClick(event);
        }

        CaptchaState.userInteraction.lastX = clickX;
        CaptchaState.userInteraction.lastY = clickY;
        CaptchaState.userInteraction.mouseMoved = false;
    });


    

    if (captchaBox) {
        captchaBox.addEventListener("mouseenter", (event) => MouseTracker.startTracking(event));
        captchaBox.addEventListener("mousemove", (event) => MouseTracker.trackMovement(event));
    }
});


// âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ù‚Ø±Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©
async function handleFakeClick(event) {
    event.preventDefault();
    CaptchaState.fakeClickCount++;

    const boxIndex = [...checkboxContainer.querySelectorAll('input')].indexOf(event.target);
    CaptchaState.fakeBoxIndexes.push(boxIndex);

    if (CaptchaState.fakeClickCount === 1) {
        console.log("âš ï¸ First Fail");
        setupCaptcha();
    } else if (CaptchaState.fakeClickCount === 2) {
        console.log("âš ï¸ Second Fail: Banned for 2 Sec");
        startBanTimer(2); // Ù…Ø¤Ù‚Øª Ø¨Ø³ÙŠØ· Ù„Ù„Ø­Ø¸Ø± Ø§Ù„Ù…Ø¤Ù‚Øª
    } else if (CaptchaState.fakeClickCount >= 3) {
        console.log("âš ï¸ Third Fail: Banned!");
        disableCaptcha();

        const report = {
            mode: "robot-detected",
            reason: "Three fake clicks detected",
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            boxIndexes: CaptchaState.fakeBoxIndexes,
            pageUrl: window.location.href
        };

        // âœ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø³ÙŠØ±ÙØ±
        const result = await sendToBackend(report);

        // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¸Ø± Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        if (result?.status === "banned") {
            checkboxContainer.innerHTML = `
                <div style="color: red; font-size: 20px; font-weight: bold;">
                    ğŸš« Access denied. You have been permanently banned.
                </div>`;
        }

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø­Ø§Ù„Ø©
        CaptchaState.fakeClickCount = 0;
        CaptchaState.fakeBoxIndexes = [];
    }
}



////////////////////////////////////////////////////////////////////////////////////////////
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âœ… Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© (Utilities)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€




// âœ… Ø¨Ø¯Ø¡ Ù…Ø¤Ù‚Øª Ø­Ø¸Ø± Ù…Ø¤Ù‚Øª (ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù„ÙØªØ±Ø© Ù…Ø­Ø¯Ø¯Ø©)
function startBanTimer(seconds) {
    checkboxContainer.style.pointerEvents = "none"; // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ù…Ø¤Ù‚ØªØ§Ù‹
    updateCaptchaBox(`â³ ${seconds}`, "orange"); // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø¯Ø§Ø¯
    seconds--;

    // ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© Ù†Ø­Ø¯Ø« Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±
    const interval = setInterval(() => {
        updateCaptchaBox(`â³ ${seconds--}`, "orange");

        if (seconds < 0) {
            clearInterval(interval); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯
            checkboxContainer.style.pointerEvents = "auto"; // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†Ù‚Ø±
            updateCaptchaBox("ğŸ”„ You can try again.", "green"); // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            setTimeout(setupCaptcha, 1500); // Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§ Ø¨Ø¹Ø¯ 1.5 Ø«Ø§Ù†ÙŠØ©
        }
    }, 1000);
}

// âœ… Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§ Ø¨Ù„ÙˆÙ† Ù…Ø¹ÙŠÙ†
function updateCaptchaBox(message, color = "black") {
    checkboxContainer.innerHTML = `
        <div style="color: ${color}; font-size: 20px; font-weight: bold;">
            ${message}
        </div>`;
}

// âœ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙƒØ§Ø¨ØªØ´Ø§ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù… Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø®Ø§Ø·Ø¦Ø©
function disableCaptcha() {
    updateCaptchaBox("ğŸš« You have been permanently banned.", "red"); // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø­Ø¸Ø±
    checkboxContainer.style.pointerEvents = "none"; // Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
}

