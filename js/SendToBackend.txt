// ğŸ“¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„
const API_URL = "https://localhost:7089/api/captcha"; // ØºÙŠÙ‘Ø±Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©

// ğŸ§© Ø¯Ø§Ù„Ø© ØªØ±Ø¬Ø¹ ÙƒØ§Ø¦Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø§Ù„Ø®Ø·Ø£ ÙˆØ³Ø¨Ø¨Ù‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£
function getErrorInfo(type) {
  const errors = {
    "fake-box": {
      errorCode: 1001, // ğŸ”´ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù…Ø±Ø¨Ø¹ Ù…Ø²ÙŠÙ
      reason: "Clicked on fake box"
    },
    "too-fast": {
      errorCode: 1002, // â±ï¸ ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¨Ø³Ø±Ø¹Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§
      reason: "Click was too fast"
    },
    "center-click": {
      errorCode: 1003, // ğŸ¯ Ø§Ù„Ù†Ù‚Ø± ÙƒØ§Ù† Ù…Ø«Ø§Ù„ÙŠ Ø¬Ø¯Ù‹Ø§ (ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ²)
      reason: "Click was too perfect (center)"
    },
    "no-movement": {
      errorCode: 1004, // ğŸ›‘ Ù„Ù… ÙŠØªÙ… ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ø§ÙˆØ³ Ø£Ø¨Ø¯Ù‹Ø§
      reason: "No mouse movement detected"
    },
    "unknown": {
      errorCode: 3000, // â“ Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©
      reason: "Unknown or untracked attempt"
    }
  };

  // âœ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ØŒ Ø£Ùˆ "unknown" Ø¥Ø°Ø§ Ù„Ù… ÙŠÙØ¹Ø±Ù Ø§Ù„Ù†ÙˆØ¹
  return errors[type] || errors["unknown"];
}

// ğŸš€ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
export async function sendToBackend(data, clickedFakeBox = false, errorType = null) {
  // ğŸ•’ ØªÙˆØ«ÙŠÙ‚ ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  const timestamp = new Date().toISOString();

  // ğŸ§± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© Ø§Ù„ØªÙŠ ØªÙØ¶Ø§Ù Ù„Ø£ÙŠ Ù†ÙˆØ¹ Ù…Ù† Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  const basePayload = {
    timestamp,
    ...(data.boxIndex !== undefined && { boxIndex: data.boxIndex }) // âœ… Ù†Ø¶ÙŠÙ boxIndex ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯
  };

  let payload; // âœ‰ï¸ Ø§Ù„Ø­Ù…ÙˆÙ„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„ØªÙŠ Ø³ØªØ±Ø³Ù„ Ù„Ù„Ø®Ø§Ø¯Ù…

  // ğŸ¤– Ø¥Ø°Ø§ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø±ÙˆØ¨ÙˆØª Ù…Ø¨Ø§Ø´Ø±Ø©Ù‹ØŒ Ù†Ø±Ø³Ù„ Ø§Ù„Ø¯Ø§ØªØ§ ÙƒÙ…Ø§ Ù‡ÙŠ + ÙˆÙ‚ØªÙ‡Ø§
  if (data.mode === "robot-detected") {
    payload = { ...data, ...basePayload };

  // âŒ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù…Ø±Ø¨Ø¹ Ù…Ø²ÙŠÙØŒ Ù†Ø±Ø³Ù„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø·Ø£ ÙˆØ§Ù„Ø³Ø¨Ø¨ ÙˆÙ†Ø­Ø¯Ø¯ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø¹Ù„Ù‰ Ø£Ù†Ù‡ Ø±ÙˆØ¨ÙˆØª
  } else if (clickedFakeBox) {
    const { errorCode, reason } = getErrorInfo(errorType);
    payload = {
      ...basePayload,
      clickedFakeBox: true,
      behaviorType: "robot",
      movementPattern: "clicked-fake-box",
      errorCode,
      reason
    };

  // âœ… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø§Ø¯ÙŠØ© Ù†Ø§Ø¬Ø­Ø©ØŒ Ù†Ø±Ø³Ù„Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª
  } else {
    payload = { ...data, ...basePayload };
  }

  try {
    // ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ø¨Ø± POST
    const response = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    // âš ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ø¬Ø§Ø­ Ø§Ù„Ø·Ù„Ø¨
    if (!response.ok) {
      console.warn("âš ï¸ Server error:", response.status);
      return { success: false };
    }

    // ğŸ§¾ Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
    const result = await response.json().catch(() => null);

    // âŒ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¯ (Ø±Ø¨Ù…Ø§ Ù„ÙŠØ³ JSON ØµØ­ÙŠØ­)
    if (!result) {
      console.error("âŒ Failed to parse server response!");
      return { success: false };
    }

    // ğŸ“¡ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±Ø¯ Ø§Ù„Ù†Ø§Ø¬Ø­
    console.log("ğŸ“¡ Backend response:", result);
    return result;

  } catch (error) {
    // ğŸ§¨ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
    console.error("âŒ Error sending data to API:", error);
    return { success: false };
  }
}
